    #
    # Copyright (c) 2019-2020 P3TERX <https://p3terx.com>
    #
    # This is free software, licensed under the MIT License.
    # See /LICENSE for more information.
    #
    # https://github.com/P3TERX/Actions-istoreos
    # Description: Build istoreos using GitHub Actions
    #

    name: istoreos

    on:
    #  schedule:
    #    - cron: 0 20 * * *

      release:
        types: [published]
     
      watch:
        types: [started]

      repository_dispatch:
      workflow_dispatch:
        inputs:
          ssh:
            description: 'SSH connection to Actions'
            required: false
            default: 'false'

    env:
      REPO_URL: https://github.com/istoreos/istoreos.git
      REPO_BRANCH: istoreos-22.03
      FEEDS_CONF: feeds.conf
      CONFIG_FILE: config/istoreos.info
      Firmware_Name: istoreos
      DIY_P1_SH: istoreos/istoreos-1.sh
      DIY_P2_SH: istoreos/istoreos-2.sh
      UPLOAD_BIN_DIR: false
      UPLOAD_FIRMWARE: false
      UPLOAD_COWTRANSFER: false
      UPLOAD_WETRANSFER: false
      UPLOAD_RELEASE: false
      GITHUB_TOKEN: ${{ secrets.GIT_USER_TOKEN }}
      TZ: Asia/Shanghai

    jobs:
      build_openwrt:

        name: istoreos 
      
        runs-on: ubuntu-latest

        steps:
        - name: å‡†å¤‡å®Œæˆ
          uses: actions/checkout@v4

        - name: æ£€æŸ¥æœåŠ¡å™¨é…ç½®
          env:
            DEBIAN_FRONTEND: noninteractive
          run: |
            echo "è‹¥åˆ†é…çš„æœåŠ¡å™¨æ€§èƒ½ä¸è¶³ï¼ŒåŠ¡å¿…åŠæ—¶å–æ¶ˆï¼Œé‡æ–°è¿è¡Œï¼"
            echo -e "------------------------------- CPUä¿¡æ¯ -------------------------------\n"
            echo "CPUç‰©ç†æ•°é‡:$(cat /proc/cpuinfo| grep "physical id"| sort| uniq| wc -l)"
            echo -e "CPUæ ¸å¿ƒåŠç‰ˆæœ¬ä¿¡æ¯: $(cat /proc/cpuinfo | grep name | cut -f2 -d: | uniq -c) \n"
            echo -e "------------------------------- å†…å­˜ä¿¡æ¯ -------------------------------\n"
            echo "å·²å®‰è£…å†…å­˜è¯¦ç»†ä¿¡æ¯: "
            sudo lshw -short -C memory | grep GiB
            echo -e "\n"
            echo -e "------------------------------- ç£ç›˜ä¿¡æ¯ -------------------------------\n"
            echo -e "ç£ç›˜æ•°é‡: $(ls /dev/sd* | grep -v [1-9] | wc -l) \n"
            echo "------------------------------- ç£ç›˜è¯¦æƒ… -------------------------------\n"
            df -Th
            
        - name: åˆå§‹åŒ–ç³»ç»Ÿç¯å¢ƒ
          env:
            DEBIAN_FRONTEND: noninteractive
          run: |
            sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /opt/ghc
            sudo -E apt-get -qq update
            sudo -E apt-get -qq install $(curl -fsSL git.io/depends-ubuntu-latest)
            sudo -E apt-get install -y ack antlr3 asciidoc autoconf automake autopoint binutils bison build-essential \
            bzip2 ccache cmake cpio curl device-tree-compiler fastjar flex gawk gettext gcc-multilib g++-multilib \
            git gperf haveged help2man intltool libc6-dev-i386 libelf-dev libglib2.0-dev libgmp3-dev libltdl-dev \
            libmpc-dev libmpfr-dev libncurses5-dev libncursesw5-dev libreadline-dev libssl-dev libtool lrzsz \
            mkisofs msmtp nano ninja-build p7zip p7zip-full patch pkgconf python2.7 python3 python3-pyelftools \
            libpython3-dev qemu-utils rsync scons squashfs-tools subversion swig texinfo uglifyjs upx-ucl unzip \
            vim wget xmlto xxd zlib1g-dev python3-setuptools
            sudo -E apt-get -qq autoremove --purge
            sudo -E apt-get -qq clean
            sudo timedatectl set-timezone "$TZ"
            sudo mkdir -p /workdir
            sudo chown $USER:$GROUPS /workdir
            echo "FILE_DATE=_$(date +"%Y%m%d%H%M")" >> $GITHUB_ENV
            
        - name: å…‹éš†æºç 
          working-directory: /workdir
          run: |
            df -hT $PWD
            git clone $REPO_URL -b $REPO_BRANCH openwrt
            ln -sf /workdir/openwrt $GITHUB_WORKSPACE/openwrt

        - name: æ›´æ–°æ—¶åŒºã€ç¼–è¯‘æ—¶é—´
          id: date
          run: |
            sudo timedatectl set-timezone "$TZ"
            echo "FILE_TIME=$(date +"%m-%d %H.%M")" >> $GITHUB_ENV
            echo "FILE_TIME1=$(date "+%Yå¹´%mæœˆ%dæ—¥-%Hç‚¹%Måˆ†")" >> $GITHUB_ENV
            echo "FILE_TIME2=$(date "+%Y%m%d-%H%M")" >> $GITHUB_ENV
            echo "ç¼–è¯‘å¼€å§‹æ—¶é—´..."
            START_TIME=`date +'%Y-%m-%d %H:%M:%S'`
            echo "START_SECONDS=$(date --date="$START_TIME" +%s)" >> $GITHUB_ENV
            
            
        # - name: ç¼“å­˜æ„å»ºåŠ¨ä½œ
          # uses: klever1988/cachewrtbuild@main
          # with:
            # ccache: 'true'
            # mixkey: ${{ matrix.os }}-${{ matrix.ARCHITECTURE }}-${{ matrix.REPO_BRANCH }}
            # prefix: ${{ github.workspace }}/openwrt
            
            
            
        # - name: SSH connection to Actions
          # uses: P3TERX/ssh2actions@v1.0.0
          # if: (github.event.inputs.ssh == 'true' && github.event.inputs.ssh  != 'false') || contains(github.event.action, 'ssh')
          # env:
            # TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
            # TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}

        - name: patch1è¡¥ä¸å’Œè‡ªå®šä¹‰è®¾ç½®
          run: |
            [ -e $FEEDS_CONF ] && mv $FEEDS_CONF openwrt/$FEEDS_CONF
            chmod +x $DIY_P1_SH
            cd openwrt
            $GITHUB_WORKSPACE/$DIY_P1_SH
            
        - name: æ›´æ–°æº #Update feeds
          run: cd openwrt && ./scripts/feeds update -a

        - name: å®‰è£…æº #Install feeds
          run: cd openwrt && ./scripts/feeds install -a

        - name: patch2è¡¥ä¸å’Œè‡ªå®šä¹‰è®¾ç½®
          run: |
            [ -e files ] && mv files openwrt/files
            [ -e $CONFIG_FILE ] && mv $CONFIG_FILE openwrt/.config
            chmod +x $DIY_P2_SH
            cd openwrt
            $GITHUB_WORKSPACE/$DIY_P2_SH



        - name: SSH connection to Actions
          uses: P3TERX/ssh2actions@v1.0.0
          if: (github.event.inputs.ssh == 'true' && github.event.inputs.ssh  != 'false') || contains(github.event.action, 'ssh')
          env:
            TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
            TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
            
            
        - name: ä¸‹è½½è½¯ä»¶åŒ…
          id: package
          run: |
            cd openwrt
            make defconfig
            make download -j8
            find dl -size -1024c -exec ls -l {} \;
            find dl -size -1024c -exec rm -f {} \;
            
        # - name: SSH connection to Actions
          # uses: P3TERX/ssh2actions@v1.0.0
          # if: (github.event.inputs.ssh == 'true' && github.event.inputs.ssh  != 'false') || contains(github.event.action, 'ssh')
          # env:
            # TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
            # TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}

        - name: å¼€å§‹ç¼–è¯‘å›ºä»¶
          id: compile
          run: |
            cd openwrt
            echo -e "$(nproc) thread compile"
            make -j$(nproc) || make -j1 || make -j1 V=s
            echo "{status}={success}" >> $GITHUB_OUTPUT
            # grep '^CONFIG_TARGET.*DEVICE.*=y' .config | sed -r 's/.*DEVICE_(.*)=y/\1/' > DEVICE_NAME
            [ -s DEVICE_NAME ] && echo "DEVICE_NAME=_$(cat DEVICE_NAME)" >> $GITHUB_ENV
            echo "FILE_DATE=_$(date +"%Y%m%d%H%M")" >> $GITHUB_ENV
            
        - name: æ£€æŸ¥ç©ºé—´ä½¿ç”¨æƒ…å†µ
          if: (!cancelled())
          run: |
            echo "======================="
            echo "Space usage:"
            echo "======================="
            df -hT
            echo "======================="
            du -h --max-depth=1 openwrt/ --exclude=build_dir --exclude=bin
            du -h --max-depth=1 openwrt/build_dir
            du -h --max-depth=1 openwrt/bin

        - name: æ•´ç†å›ºä»¶æ–‡ä»¶
          if: (!cancelled())
          run: |
            cd openwrt
            mkdir -p ./artifact/firmware
            mkdir -p ./artifact/package
            mkdir -p ./artifact/buildinfo
            rm -rf $(find ./bin/targets/ -type d -name "packages")
            cp -rf .config ./artifact/buildinfo/config.info
            cp -rf $(find ./bin/targets/ -type f) ./artifact/firmware/
            cp -rf $(find ./bin/packages/ -type f -name "*.ipk") ./artifact/package/
            cp -rf $(find ./bin/targets/ -type f -name "*.buildinfo" -o -name "*.manifest") ./artifact/buildinfo/
            cd artifact
            echo "FIRMWARE=$PWD" >> $GITHUB_ENV
            echo "{status}={success}" >> $GITHUB_OUTPUT  
        
        - name: ä¸Šä¼  bin æ–‡ä»¶å¤¹
          uses: actions/upload-artifact@main
          if: steps.compile.outputs.status == 'success' && env.UPLOAD_BIN_DIR == 'true'
          with:
            name: ${{ env.Firmware_Name }}_${{ env.REPO_BRANCH }}_bin${{ env.DEVICE_NAME }}${{ env.FILE_DATE }}
            path: ${{ env.FIRMWARE }}/bin/

          
        - name: ä¸Šä¼ å›ºä»¶ç›®å½•
          uses: actions/upload-artifact@v4
          if: env.UPLOAD_FIRMWARE == 'true' && !cancelled()
          with:
            name: ${{ env.Firmware_Name }}_${{ env.REPO_BRANCH }}_firmware_${{ env.DEVICE_NAME }}${{ env.FILE_DATE }}
            path: ${{ env.FIRMWARE }}/firmware/

        - name: ä¸Šä¼  buildinfoç›®å½•
          uses: actions/upload-artifact@v4
          if: steps.compile.outputs.status == 'success' && steps.organize.outputs.status == 'success'
          with:
            name: ${{ env.Firmware_Name }}_${{ env.REPO_BRANCH }}_buildinfo${{ env.DEVICE_NAME }}${{ env.FILE_DATE }}
            path: ${{ env.FIRMWARE }}/buildinfo/

        - name: ä¸Šä¼  packageç›®å½•
          uses: actions/upload-artifact@v4
          if: steps.compile.outputs.status == 'success' && steps.organize.outputs.status == 'success'
          with:
            name: ${{ env.Firmware_Name }}_${{ env.REPO_BRANCH }}_package${{ env.DEVICE_NAME }}${{ env.FILE_DATE }}
            path: ${{ env.FIRMWARE }}/package/


        - name: å›ºä»¶ç›®å½•
          run: |
            cd openwrt/bin/targets/*/*
            echo "FIRMWARE=$PWD" >> $GITHUB_ENV
            echo "status=success" >> $GITHUB_OUTPUT


        - name: ä¸Šä¼ å›ºä»¶ to cowtransfer
          id: cowtransfer
          if: steps.organize.outputs.status == 'success' && env.UPLOAD_COWTRANSFER == 'true' && !cancelled()
          run: |
            curl -fsSL git.io/file-transfer | sh
            ./transfer cow --block 2621440 -s -p 64 --no-progress ${FIRMWARE} 2>&1 | tee cowtransfer.log
            echo "::warning file=cowtransfer.com::$(cat cowtransfer.log | grep https)"
            echo "{url}={$(cat cowtransfer.log | grep https | cut -f3 -d" ")}" >> $GITHUB_OUTPUT

        - name: ä¸Šä¼ å›ºä»¶ to WeTransfer
          id: wetransfer
          if: steps.organize.outputs.status == 'success' && env.UPLOAD_WETRANSFER == 'true' && !cancelled()
          run: |
            curl -fsSL git.io/file-transfer | sh
            ./transfer wet -s -p 16 --no-progress ${FIRMWARE} 2>&1 | tee wetransfer.log
            echo "::warning file=wetransfer.com::$(cat wetransfer.log | grep https)"
            # echo "::set-output name=url::$(cat wetransfer.log | grep https | cut -f3 -d" ")"
            echo "{url}={$(cat wetransfer.log | grep https | cut -f3 -d" ")}" >> $GITHUB_OUTPUT

        - name: ç”Ÿæˆå‘å¸ƒæ ‡ç­¾
          id: tag
          if: env.UPLOAD_RELEASE == 'true' && !cancelled()
          run: |
            # echo "::set-output name=release_tag::$(date +"%Y.%m.%d-%H%M")"
            echo "{release_tag}={$(date +"%Y.%m.%d-%H%M")}" >> $GITHUB_OUTPUT
            touch release.txt
            echo "
            ğŸ’» æ¶æ„: ${{ matrix.ARCHITECTURE }}

            ğŸ“‚ æºç : ${{ env.REPO_URL }}

            ğŸŒ³ åˆ†æ”¯: ${{ matrix.REPO_BRANCH }}

            â±ï¸ ç¼–è¯‘æ—¶é—´: $(date +"%Yå¹´%mæœˆ%dæ—¥%Hæ—¶%Måˆ†")

            ğŸŒ ç®¡ç†åœ°å€: 10.0.0.1

            ğŸ‘¤ ç”¨æˆ·å: root

            ğŸ”’ å¯†ç : password " >> release.txt
            [ $UPLOAD_COWTRANSFER = true ] && echo "ğŸ”— [Cowtransfer](${{ steps.cowtransfer.outputs.url }})" >> release.txt
            [ $UPLOAD_WETRANSFER = true ] && echo "ğŸ”— [WeTransfer](${{ steps.wetransfer.outputs.url }})" >> release.txt
            echo "status=success" >> $GITHUB_OUTPUT

        - name: è‡ªåŠ¨å‘å¸ƒå›ºä»¶åˆ° Releases
          uses: softprops/action-gh-release@v1
          if: steps.tag.outputs.status == 'success' && !cancelled()
          env:
            GITHUB_TOKEN: ${{ secrets.GIT_USER_TOKEN }}
          with:
            tag_name: ${{ steps.tag.outputs.release_tag }}
            body_path: release.txt
            files: ${{ env.FIRMWARE }}/*

        - name: åˆ é™¤è¿è¡Œè®°å½•
          uses: GitRML/delete-workflow-runs@main
          with:
            retain_days: 10
            keep_minimum_runs: 3

        - name: åˆ é™¤è‡ªåŠ¨å‘å¸ƒçš„æ—§å›ºä»¶
          uses: dev-drprasad/delete-older-releases@v0.3.2
          if: env.UPLOAD_RELEASE == 'true' && !cancelled()
          with:
            keep_latest: 3
            delete_tags: true
          env:
            GITHUB_TOKEN: ${{ secrets.GIT_USER_TOKEN }}

